<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ระบบสุริยะ (AR Description Fix)</title>

  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

  <style>
    /* === Global Styles === */
    html, body {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      background-color: #000;
      font-family: 'Kanit', 'Segoe UI', Tahoma, sans-serif;
      touch-action: none; 
    }

    a-scene {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
    }

    .a-enter-vr-button { display: none !important; }

    /* === UI Overlay === */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 100;
    }
    #ui-layer > * { pointer-events: auto; }

    /* === Gear Button === */
    #settingsBtn {
      position: absolute; top: 20px; right: 20px;
      width: 48px; height: 48px; border-radius: 50%;
      background: rgba(30, 30, 40, 0.8); backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3); color: white;
      font-size: 24px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease; z-index: 200;
    }
    #settingsBtn:hover {
      background: rgba(100, 100, 255, 0.4); transform: rotate(90deg);
    }

    /* === Settings Menu === */
    #settingsMenu {
      position: absolute; top: 80px; right: 20px; width: 240px;
      background: rgba(20, 20, 35, 0.95); backdrop-filter: blur(12px);
      border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 16px; display: flex; flex-direction: column; gap: 12px;
      transform-origin: top right; transform: scale(0); opacity: 0;
      transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); visibility: hidden;
    }
    #settingsMenu.active { transform: scale(1); opacity: 1; visibility: visible; }
    .menu-item { display: flex; flex-direction: column; gap: 6px; color: #ddd; font-size: 14px; }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; }

    /* Switch Style */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #555; transition: .4s; border-radius: 24px;
    }
    .slider:before {
      position: absolute; content: ""; height: 18px; width: 18px;
      left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #bb86fc; }
    input:checked + .slider:before { transform: translateX(20px); }
    input[type=range] {
      width: 100%; accent-color: #bb86fc; height: 4px;
      background: rgba(255,255,255,0.2); border-radius: 2px;
    }

    /* === Preview Overlay === */
    #previewOverlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      /* Default background for Normal Mode */
      background: radial-gradient(circle at center, rgba(0,0,0,0) 20%, rgba(0,0,0,0.8) 80%, rgba(0,0,0,0.95) 100%);
      display: none; flex-direction: column; align-items: center; justify-content: flex-end;
      z-index: 300; pointer-events: auto;
    }
    
    /* Specific style for AR Mode */
    #previewOverlay.ar-mode-style {
       background: transparent; /* No dark background in AR */
       justify-content: flex-end; /* Push content to bottom */
    }
    
    #previewOverlay.active { display: flex; }

    .preview-controls {
      margin-bottom: 50px; text-align: center; pointer-events: auto;
      width: 100%; padding: 0 20px; box-sizing: border-box;
    }
    
    /* Add background to controls in AR so text is readable */
    #previewOverlay.ar-mode-style .preview-controls {
        background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));
        padding-bottom: 60px;
        padding-top: 40px;
    }

    #previewTitle {
      color: #fff; font-size: 2.2rem; font-weight: bold;
      text-shadow: 0 2px 10px rgba(187, 134, 252, 0.8); margin-bottom: 10px;
    }

    #previewDesc {
      color: #ccc; margin-bottom: 20px; max-width: 600px;
      margin-left: auto; margin-right: auto; font-size: 1rem; line-height: 1.5;
      background: rgba(0, 0, 0, 0.5); padding: 15px 20px; border-radius: 12px;
      backdrop-filter: blur(5px);
    }

    #rotateHint {
        font-size: 0.8rem; color: #888; margin-top: -10px; margin-bottom: 15px;
    }

    #closePreviewBtn {
      background: linear-gradient(135deg, #ff4b1f, #ff9068);
      color: white; border: none; padding: 12px 30px;
      border-radius: 30px; font-size: 16px; font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 75, 31, 0.4); cursor: pointer;
    }

    /* Bottom AR Button */
    .bottom-cta {
      position: absolute; bottom: 80px; left: 0; width: 100%;
      display: flex; justify-content: center;
      padding-bottom: env(safe-area-inset-bottom); pointer-events: none;
    }
    #arButton {
      pointer-events: auto;
      background: linear-gradient(135deg, #ff0080, #7928ca);
      color: white; border: none; padding: 14px 40px;
      border-radius: 30px; font-size: 16px; font-weight: bold;
      box-shadow: 0 4px 20px rgba(255, 0, 128, 0.4);
    }
  </style>

  <script>
    // Component: Zoom
    AFRAME.registerComponent('ar-scale-manager', {
      schema: { min: {default: 0.05}, max: {default: 10} },
      init: function() {
        this.wrapper = document.getElementById('solar-system-wrapper');
        this.initialDist = 0; this.initialScale = 1; this.isPinching = false;
        window.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            this.isPinching = true;
            this.initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            this.initialScale = this.wrapper.object3D.scale.x;
          }
        }, {passive: false});
        window.addEventListener('touchmove', (e) => {
          if (this.isPinching && e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            let newScale = this.initialScale * (currentDist / this.initialDist);
            newScale = Math.min(Math.max(newScale, this.data.min), this.data.max);
            this.wrapper.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
          }
        }, {passive: false});
        window.addEventListener('touchend', () => { this.isPinching = false; });
      }
    });

    // Component: AR Controller
    AFRAME.registerComponent('ar-controller', {
      init: function () {
        const sceneEl = this.el;
        const sky = document.getElementById('sky');
        const arBtn = document.getElementById('arButton');
        const wrapper = document.getElementById('solar-system-wrapper');
        
        // Handle Entering AR/VR Mode
        sceneEl.addEventListener('enter-vr', () => {
          if (sceneEl.is('ar-mode')) {
            if(sky) sky.setAttribute('visible', false);
            if(arBtn) arBtn.style.display = 'none';
            wrapper.setAttribute('position', '0 -0.5 -2'); 
            wrapper.setAttribute('scale', '0.2 0.2 0.2');
            
            // Sync checkbox state
            const toggleSky = document.getElementById('toggleSky');
            if(toggleSky) toggleSky.checked = true;
          }
        });

        sceneEl.addEventListener('exit-vr', () => {
          const toggleSky = document.getElementById('toggleSky');
          if(toggleSky) toggleSky.checked = false;
          
          if(sky) sky.setAttribute('visible', true);
          if(arBtn) arBtn.style.display = 'block';
          wrapper.setAttribute('position', '0 0 0');
          wrapper.setAttribute('scale', '1 1 1');
          
          // Reset UI Style
          document.getElementById('previewOverlay').classList.remove('ar-mode-style');
        });
      }
    });
  </script>
</head>

<body>

  <div id="ui-layer">
    
    <button id="settingsBtn">⚙️</button>

    <div id="settingsMenu">
      <div class="menu-item toggle-row">
        <span>แสดงวงโคจร</span>
        <label class="switch">
          <input type="checkbox" id="toggleOrbits" checked>
          <span class="slider"></span>
        </label>
      </div>
      <div class="menu-item toggle-row">
        <span>แสดงชื่อดาว</span>
        <label class="switch">
          <input type="checkbox" id="toggleLabels" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div class="menu-item toggle-row">
        <span>แสดงคำบรรยาย</span>
        <label class="switch">
          <input type="checkbox" id="toggleDesc" checked>
          <span class="slider"></span>
        </label>
      </div>

      <div class="menu-item toggle-row">
        <span style="color:#bb86fc; font-weight:bold;">ซ่อนพื้นหลัง</span>
        <label class="switch">
          <input type="checkbox" id="toggleSky">
          <span class="slider"></span>
        </label>
      </div>

      <hr style="width: 100%; border: 0; border-top: 1px solid rgba(255,255,255,0.1);">
      <div class="menu-item">
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
          <span>ความเร็วการหมุน</span>
          <span id="speedValue" style="color:#bb86fc">1.0x</span>
        </div>
        <input type="range" id="speedSlider" min="0" max="5" step="0.5" value="1">
      </div>
    </div>

    <div id="previewOverlay">
      <div class="preview-controls">
        <h2 id="previewTitle">ดาว...</h2>
        <p id="previewDesc">รายละเอียด...</p>
        <p id="rotateHint">(ใช้นิ้วเลื่อนเพื่อหมุนดาว)</p>
        <button id="closePreviewBtn">ปิดหน้าต่าง</button>
      </div>
    </div>

    <div class="bottom-cta">
      <button id="arButton">✨ เข้าสู่โหมด AR</button>
    </div>

  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    ar-controller
    ar-scale-manager
    cursor="rayOrigin: mouse; fuse: false" 
    raycaster="objects: .clickable"
    renderer="colorManagement: true; antialias: true; alpha: true; precision: high"
    webxr="optionalFeatures: dom-overlay; overlayElement: #ui-layer">

    <a-assets>
       <img id="skyTexture" src="textures/stars.jpg">
    </a-assets>

    <a-sky id="sky" src="#skyTexture"></a-sky>

    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: point; intensity: 1.5; distance: 50; decay: 2" position="0 0 0"></a-entity>

    <a-entity id="cameraRig" position="0 1.6 8">
      <a-entity camera look-controls wasd-controls>
        <a-entity id="preview-rig" visible="false" position="0 0 -2.5">
          <a-entity light="type: directional; intensity: 2; color: #fff" position="1 1 2"></a-entity>
          <a-sphere id="preview-planet-mesh" radius="0.6" 
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear; enabled: false">
          </a-sphere>
        </a-entity>
      </a-entity>
    </a-entity>

    <a-entity id="solar-system-wrapper">
      
      <a-entity id="sun-parent" position="0 0 0">
        <a-sphere id="sun" radius="1.2" src="textures/sun.jpg" color="#FDB813" class="clickable planet-mesh"
                  data-name="Sun (ดวงอาทิตย์)" data-info="ศูนย์กลางของระบบสุริยะ แหล่งพลังงานที่สำคัญที่สุดของโลก"></a-sphere>
        <a-sphere radius="1.4" color="#FDB813" opacity="0.3" transparent="true" segments-width="16" segments-height="16" material="side: back"></a-sphere>
      </a-entity>

      <a-entity id="orbit-mercury" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="1.59" radius-outer="1.60" color="#ffffff" opacity="0.2" segments-theta="32"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:8000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="1.6 0 0">
            <a-sphere class="clickable" radius="0.3" visible="false"></a-sphere> 
            <a-sphere class="planet-mesh" radius="0.08" src="textures/mercury.jpg" color="#A5A5A5"
                      data-name="Mercury (ดาวพุธ)" data-info="ดาวเคราะห์ที่เล็กที่สุดและอยู่ใกล้ดวงอาทิตย์ที่สุด ร้อนจัดและเย็นจัด"></a-sphere>
            <a-text class="planet-label" value="Mercury" align="center" position="0 0.25 0" scale="0.5 0.5 0.5" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-venus" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="2.29" radius-outer="2.30" color="#ffffff" opacity="0.2"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:12000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="2.3 0 0">
            <a-sphere class="clickable" radius="0.4" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.14" src="textures/venus.jpg" color="#E3BB76"
                      data-name="Venus (ดาวศุกร์)" data-info="ฝาแฝดของโลก ปกคลุมด้วยแก๊สเรือนกระจกหนาแน่น ทำให้ร้อนที่สุดในระบบสุริยะ"></a-sphere>
            <a-text class="planet-label" value="Venus" align="center" position="0 0.35 0" scale="0.6 0.6 0.6" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-earth" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="3.19" radius-outer="3.20" color="#ffffff" opacity="0.2"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:18000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="3.2 0 0">
            <a-sphere class="clickable" radius="0.5" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.18" src="textures/earth.jpg" color="#4B9CD3"
                      data-name="Earth (โลก)" data-info="ดาวเคราะห์สีน้ำเงิน ดาวดวงเดียวที่มีสิ่งมีชีวิตและน้ำในสถานะของเหลว"></a-sphere>
            <a-text class="planet-label" value="Earth" align="center" position="0 0.45 0" scale="0.6 0.6 0.6" side="double"></a-text>
            <a-entity animation="property:rotation; to:0 360 0; dur:3000; loop:true; easing:linear">
               <a-sphere radius="0.05" position="0.3 0 0" src="textures/moon.jpg" color="#ddd"></a-sphere>
            </a-entity>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-mars" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="4.09" radius-outer="4.10" color="#ffffff" opacity="0.2"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:24000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="4.1 0 0">
            <a-sphere class="clickable" radius="0.4" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.12" src="textures/mars.jpg" color="#E27B58"
                      data-name="Mars (ดาวอังคาร)" data-info="ดาวแดง เต็มไปด้วยพายุฝุ่นและภูเขาไฟที่สูงที่สุดในระบบสุริยะ"></a-sphere>
            <a-text class="planet-label" value="Mars" align="center" position="0 0.35 0" scale="0.6 0.6 0.6" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-jupiter" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="5.99" radius-outer="6.00" color="#ffffff" opacity="0.2"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:38000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="6.0 0 0">
            <a-sphere class="clickable" radius="0.8" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.5" src="textures/jupiter.jpg" color="#C88B3A"
                      data-name="Jupiter (ดาวพฤหัส)" data-info="พี่ใหญ่แห่งระบบสุริยะ ดาวแก๊สยักษ์ที่มีพายุหมุนแดงใหญ่ (Great Red Spot)"></a-sphere>
            <a-text class="planet-label" value="Jupiter" align="center" position="0 0.9 0" scale="1 1 1" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-saturn" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="7.99" radius-outer="8.00" color="#ffffff" opacity="0.2"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:48000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="8.0 0 0">
            <a-sphere class="clickable" radius="0.8" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.45" src="textures/saturn.jpg" color="#C5AB6E"
                      data-name="Saturn (ดาวเสาร์)" data-info="โดดเด่นด้วยวงแหวนน้ำแข็งที่สวยงาม เป็นดาวเคราะห์ที่มีความหนาแน่นน้อยกว่าน้ำ"></a-sphere>
            <a-ring rotation="90 0 0" radius-inner="0.6" radius-outer="1.0" color="#C5AB6E" opacity="0.8" side="double"></a-ring>
            <a-text class="planet-label" value="Saturn" align="center" position="0 0.8 0" scale="0.9 0.9 0.9" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-uranus" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="9.49" radius-outer="9.50" color="#ffffff" opacity="0.2" segments-theta="64"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:58000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="9.5 0 0">
            <a-sphere class="clickable" radius="0.6" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.3" src="textures/uranus.jpg" color="#4FD0E7"
                      data-name="Uranus (ดาวยูเรนัส)"
                      data-info="ดาวมฤตยู หมุนรอบตัวเองแบบตะแคงข้าง มีบรรยากาศสีฟ้าอมเขียวจากมีเทน"></a-sphere>
            <a-text class="planet-label" value="Uranus" align="center" position="0 0.6 0" scale="0.8 0.8 0.8" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-neptune" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="10.99" radius-outer="11.00" color="#ffffff" opacity="0.2" segments-theta="64"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:68000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="11.0 0 0">
            <a-sphere class="clickable" radius="0.6" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.3" src="textures/neptune.jpg" color="#29559B"
                      data-name="Neptune (ดาวเนปจูน)"
                      data-info="ดาวเกตุ อยู่ไกลสุด มีลมพายุรุนแรงและหนาวเย็นจัด สีน้ำเงินเข้ม"></a-sphere>
            <a-text class="planet-label" value="Neptune" align="center" position="0 0.6 0" scale="0.8 0.8 0.8" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

    </a-entity> 
  </a-scene>

  <script>
    // === Logic Interaction ===

    document.getElementById('arButton').addEventListener('click', function() {
      const scene = document.querySelector('a-scene');
      scene.enterAR();
    });

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');

    settingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsMenu.classList.toggle('active');
      settingsBtn.style.transform = settingsMenu.classList.contains('active') ? 'rotate(90deg)' : 'rotate(0deg)';
    });

    document.addEventListener('click', (e) => {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.classList.remove('active');
        settingsBtn.style.transform = 'rotate(0deg)';
      }
    });

    // === Preview Logic ===
    const previewOverlay = document.getElementById('previewOverlay');
    const previewRig = document.getElementById('preview-rig');
    const previewMesh = document.getElementById('preview-planet-mesh');
    const previewTitle = document.getElementById('previewTitle');
    const previewDesc = document.getElementById('previewDesc');
    const rotateHint = document.getElementById('rotateHint');
    const solarSystem = document.getElementById('solar-system-wrapper');
    const sceneEl = document.querySelector('a-scene');

    let isPreviewing = false;
    let startX = 0;
    
    // Checkbox: Toggle Description
    const toggleDesc = document.getElementById('toggleDesc');
    toggleDesc.addEventListener('change', function() {
      const show = this.checked;
      previewDesc.style.display = show ? 'block' : 'none';
    });

    // Click Planet
    document.querySelectorAll('.clickable').forEach(el => {
      el.addEventListener('click', function(evt) {
        const planetMesh = this.parentElement.querySelector('.planet-mesh') || this;
        if (!planetMesh) return;

        const textureSrc = planetMesh.getAttribute('src');
        const color = planetMesh.getAttribute('color');
        const name = planetMesh.getAttribute('data-name');
        const info = planetMesh.getAttribute('data-info');

        // Update Text
        previewTitle.innerText = name;
        previewDesc.innerText = info;
        previewDesc.style.display = toggleDesc.checked ? 'block' : 'none';

        // Update 3D Model (Only used in Normal Mode)
        previewMesh.setAttribute('src', textureSrc);
        previewMesh.setAttribute('color', color);

        // --- KEY LOGIC CHANGE FOR AR ---
        const isAR = sceneEl.is('ar-mode');
        
        if (isAR) {
            // โหมด AR: แสดงแค่ Text Overlay แต่ไม่ซ่อน Solar System
            // และปรับ Style ของ Overlay ให้โปร่งใส
            previewOverlay.classList.add('active', 'ar-mode-style');
            
            // ซ่อน Preview Rig (เพราะใน AR มันคุมตำแหน่งยาก)
            previewRig.setAttribute('visible', false); 
            // แสดง Solar System ไว้เหมือนเดิม ให้คนเห็นว่าดาวอยู่ตรงไหน
            solarSystem.setAttribute('visible', true); 
            // ซ่อนคำแนะนำหมุน เพราะเราไม่ได้โชว์โมเดลเดี่ยว
            rotateHint.style.display = 'none';
        } else {
            // โหมดปกติ (VR/Desktop): ทำเหมือนเดิม
            previewOverlay.classList.add('active');
            previewOverlay.classList.remove('ar-mode-style');
            previewRig.setAttribute('visible', true);
            solarSystem.setAttribute('visible', false);
            rotateHint.style.display = 'block';
        }

        isPreviewing = true;
      });
    });

    // Close Preview
    document.getElementById('closePreviewBtn').addEventListener('click', () => {
      previewOverlay.classList.remove('active', 'ar-mode-style');
      previewRig.setAttribute('visible', false);
      solarSystem.setAttribute('visible', true); // Show world again
      isPreviewing = false;
    });

    // Drag to Rotate Preview (Only Normal Mode)
    document.addEventListener('touchstart', (e) => {
      if(isPreviewing && !sceneEl.is('ar-mode')) startX = e.touches[0].pageX;
    });
    document.addEventListener('touchmove', (e) => {
      if(isPreviewing && !sceneEl.is('ar-mode') && e.touches.length === 1) { 
        const currentX = e.touches[0].pageX;
        const deltaX = currentX - startX;
        previewMesh.object3D.rotation.y += deltaX * 0.01;
        startX = currentX;
      }
    });

    // Toggle Orbits
    document.getElementById('toggleOrbits').addEventListener('change', function() {
      const visible = this.checked;
      document.querySelectorAll('.orbit-ring').forEach(ring => {
        ring.setAttribute('visible', visible);
      });
    });

    // Toggle Labels
    document.getElementById('toggleLabels').addEventListener('change', function() {
      const visible = this.checked;
      document.querySelectorAll('.planet-label').forEach(label => {
        label.setAttribute('visible', visible);
      });
    });

    // Toggle Camera Mode (Hide Sky)
    document.getElementById('toggleSky').addEventListener('change', function() {
      const isCameraMode = this.checked;
      const sky = document.getElementById('sky');
      if(sky) {
        sky.setAttribute('visible', !isCameraMode);
      }
    });

    // Speed Slider
    const speedSlider = document.getElementById('speedSlider');
    const speedValue = document.getElementById('speedValue');
    speedSlider.addEventListener('input', (e) => {
      const speed = parseFloat(e.target.value);
      speedValue.innerText = speed + "x";
      document.querySelectorAll('.planet-orbit').forEach(orbit => {
        if (!orbit.getAttribute('data-original-dur')) {
          const anim = orbit.getAttribute('animation');
          if(anim) orbit.setAttribute('data-original-dur', anim.dur);
        }
        const originalDur = parseInt(orbit.getAttribute('data-original-dur'));
        if (speed === 0) {
          orbit.removeAttribute('animation');
        } else {
          const newDur = originalDur / speed;
          orbit.setAttribute('animation', `property:rotation; to:0 360 0; dur:${newDur}; loop:true; easing:linear`);
        }
      });
    });
  </script>
</body>
</html>